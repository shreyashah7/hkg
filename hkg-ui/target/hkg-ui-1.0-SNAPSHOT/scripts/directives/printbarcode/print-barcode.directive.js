/**
 * 
 * Author: Shreya
 * 
 * Objective : Print Barcode on the same page of autogenerated custoom field.
 * And also if not already generated it will generate and print.
 * 
 * Implementation:
 * 
 * <print-barcode  class="col-md-2" model-value="print.barcode" is-image-name="true"></print-barcode>
 * 
 * model-value : Model value of immage-path of value of that field.
 * is-image-name : Needed if it a Auto-Generated custom field value and only number is passed for which barcode needs to be generated and printed.
 * 
 */
define(['angular'], function () {
    globalProvider.compileProvider.directive('printBarcodeValue',
            ['$parse', '$compile', '$rootScope', '$filter', 'MasterPrintBarcodeService', 'CenterPrintBarcodeService', function ($parse, $compile, $rootScope, $filter, MasterPrintBarcodeService, CenterPrintBarcodeService) {
                    var scope = {
                        modelValue: '='
                    };
                    var link = function (scope, element, attrs) {
                    };

                    var controller = ["$scope", "$element", "$attrs", function ($scope, $element, $attrs) {
                            console.log("inside directive");
                            if (angular.isDefined($attrs.isImageName)) {
                                try {
                                    $scope.isImageName = JSON.parse($attrs.isImageName.toLowerCase());
                                } catch (exception) {
                                    $scope.isImageName = false;
                                    console.log('Can not parse isImageName' + exception);
                                }
                            } else {
                                $scope.isImageName = false;
                            }

                            if (angular.isDefined($attrs.isDiamond)) {
                                $scope.isDiamond = $attrs.isDiamond;
                            } else {
                                $scope.isDiamond = false;
                            }
                            var Service;
                            if ($scope.isDiamond) {
                                // Center Call
                                Service = CenterPrintBarcodeService;
                            }
                            else {
                                // Master Call
                                Service = MasterPrintBarcodeService;
                            }

                            $scope.printBarcode = function () {
                                if ($scope.modelValue !== null && $scope.modelValue !== undefined && $scope.modelValue !== '') {
                                    if ($scope.isDiamond) {
                                        // Center Call
                                        if ($scope.isImageName === false) {
                                            var stringVal = $scope.modelValue.toString();
                                            Service.printBarcode(stringVal, function (result) {
                                                if (result !== null && result !== undefined && result !== '' && result["tempFilePath"] !== null) {
                                                    var popup = window.open($rootScope.appendAuthToken($rootScope.centerapipath + "printbarcode/getimage/" + result["tempFilePath"]),"_blank");
                                                    popup.print();
                                                }
                                            });
                                        } else {
                                            var popup = window.open($rootScope.appendAuthToken($rootScope.apipath + "printbarcode/getimage/" + $scope.modelValue),"_blank");
                                            popup.print();
                                        }

                                    }else {
                                        // Master Call
//                                        var popup = window.open($rootScope.appendAuthToken($rootScope.apipath + "asset/getimage/" + $scope.modelValue),"_blank");
                                        var currentDomainContext;
                                        if ($rootScope.apipath.indexOf("http://") >= 0 || $rootScope.apipath.indexOf("https://") >= 0) {
                                            currentDomainContext = $rootScope.apipath;
                                        }
                                        else {
                                            currentDomainContext = window.location.href.split("#/")[0] + $rootScope.apipath;
                                        }
                                        window.open("views/unsecure/printpage.html?getimage=" + ($rootScope.appendAuthToken(currentDomainContext + "asset/getimage/" + $scope.modelValue)), "_blank");
//                                        popup.print();
                                    }
                                }
                            };
                        }];
                    return {
                        restrict: 'E',
                        scope: scope,
                        link: link,
                        template: '<div class="control-group">' +
                                '<span class="glyphicon glyphicon-barcode pull-right pointer" title="Print Barcode" style="font-size: 20px" ng-click="printBarcode()"></span>' +
                                '<div>',
                        controller: controller
                    };
                }]);
    globalProvider.provide.factory('MasterPrintBarcodeService', ['$resource', '$rootScope', function (resource, rootScope) {
            var MasterPrintBarcode = resource(rootScope.apipath + 'asset/:action', {}, {
                retrieveListOfMaster: {
                    method: 'GET',
                    isArray: true,
                    params: {
                        action: 'retrieve'
                    }
                }
            });
            return MasterPrintBarcode;
        }]);

    globalProvider.provide.factory('CenterPrintBarcodeService', ['$resource', '$rootScope', function (resource, rootScope) {
            var CenterPrintBarcode = resource(rootScope.centerapipath + 'printbarcode/:action', {}, {
                printBarcode: {
                    method: 'POST',
                    params: {
                        action: 'printbarcode'
                    }
                }
            });
            return CenterPrintBarcode;
        }]);
});